<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusChat - Multi-Room Chat Platform</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
        /* Adding new styles for room creation modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 500px;
            padding: 20px;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
        }

        .modal-button.cancel {
            background-color: #f0f0f0;
            margin-right: 10px;
        }

        .modal-button.create {
            background-color: var(--primary-color);
            color: white;
        }

        .room-type-selector {
            display: flex;
            margin-bottom: 15px;
        }

        .room-type {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .room-type:first-child {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        .room-type:last-child {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .room-type.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Dark theme adjustments for modal */
        .theme-dark .modal {
            background-color: #1e272e;
            color: #f5f6fa;
        }

        .theme-dark .modal-input {
            background-color: #2d3436;
            border-color: #333;
            color: #f5f6fa;
        }

        .theme-dark .room-type {
            border-color: #333;
            background-color: #2d3436;
        }

        .theme-dark .modal-button.cancel {
            background-color: #333;
            color: #f5f6fa;
        }
    </style>
</head>
<body class="theme-light">
    <!-- [Previous HTML structure remains the same until the sidebar footer] -->
    <!-- Only showing the modified parts for brevity -->

    <!-- Add Room Creation Modal -->
    <div class="modal-overlay" id="roomModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Room</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="room-type-selector">
                    <div class="room-type active" data-type="public">Public</div>
                    <div class="room-type" data-type="private">Private</div>
                </div>
                <input type="text" class="modal-input" id="roomNameInput" placeholder="Room name">
                <input type="text" class="modal-input" id="roomTopicInput" placeholder="Room topic (optional)">
                <div id="privateRoomFields" style="display: none;">
                    <input type="password" class="modal-input" id="roomPasswordInput" placeholder="Room password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button cancel" id="modalCancel">Cancel</button>
                <button class="modal-button create" id="modalCreate">Create</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCGuOn8VXbdZVnfgpoogTJAmiQYBXlKob4",
            authDomain: "my-chat-84879.firebaseapp.com",
            databaseURL: "https://my-chat-84879-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "my-chat-84879",
            storageBucket: "my-chat-84879.appspot.com",
            messagingSenderId: "270368603705",
            appId: "1:270368603705:web:a02009bba951371286d7e8"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userDisplayName = document.getElementById('userDisplayName');
        const logoutButton = document.getElementById('logoutButton');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const registerName = document.getElementById('registerName');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const authError = document.getElementById('authError');
        const typingIndicator = document.getElementById('typingIndicator');
        const authTitle = document.getElementById('authTitle');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const themeOptions = document.querySelectorAll('.theme-option');
        const themeDropdown = document.getElementById('themeDropdown');
        const roomModalOverlay = document.getElementById('roomModalOverlay');
        const modalClose = document.getElementById('modalClose');
        const modalCancel = document.getElementById('modalCancel');
        const modalCreate = document.getElementById('modalCreate');
        const roomNameInput = document.getElementById('roomNameInput');
        const roomTopicInput = document.getElementById('roomTopicInput');
        const roomPasswordInput = document.getElementById('roomPasswordInput');
        const privateRoomFields = document.getElementById('privateRoomFields');
        const roomTypeSelectors = document.querySelectorAll('.room-type');
        const addRoomButton = document.querySelector('.input-action[title="Add Room"]');
        const chatRoomsContainer = document.querySelector('.chat-rooms');

        // Room creation modal functionality
        function showRoomModal() {
            roomModalOverlay.classList.add('active');
            roomNameInput.focus();
        }

        function hideRoomModal() {
            roomModalOverlay.classList.remove('active');
            roomNameInput.value = '';
            roomTopicInput.value = '';
            roomPasswordInput.value = '';
            document.querySelector('.room-type[data-type="public"]').classList.add('active');
            document.querySelector('.room-type[data-type="private"]').classList.remove('active');
            privateRoomFields.style.display = 'none';
        }

        // Room type selection
        roomTypeSelectors.forEach(type => {
            type.addEventListener('click', () => {
                roomTypeSelectors.forEach(t => t.classList.remove('active'));
                type.classList.add('active');
                if (type.dataset.type === 'private') {
                    privateRoomFields.style.display = 'block';
                } else {
                    privateRoomFields.style.display = 'none';
                }
            });
        });

        // Modal event listeners
        addRoomButton.addEventListener('click', showRoomModal);
        modalClose.addEventListener('click', hideRoomModal);
        modalCancel.addEventListener('click', hideRoomModal);

        // Create new room
        modalCreate.addEventListener('click', () => {
            const roomName = roomNameInput.value.trim();
            const roomTopic = roomTopicInput.value.trim();
            const roomType = document.querySelector('.room-type.active').dataset.type;
            const roomPassword = roomPasswordInput.value.trim();
            
            if (!roomName) {
                alert('Please enter a room name');
                return;
            }

            const user = auth.currentUser;
            if (!user) return;

            const newRoomRef = database.ref('rooms').push();
            const roomData = {
                name: roomName,
                topic: roomTopic || '',
                type: roomType,
                createdBy: user.uid,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                members: {
                    [user.uid]: true
                }
            };

            if (roomType === 'private' && roomPassword) {
                roomData.password = roomPassword;
            }

            newRoomRef.set(roomData)
                .then(() => {
                    hideRoomModal();
                    // Automatically join the new room
                    joinRoom(newRoomRef.key, roomName);
                })
                .catch(error => {
                    console.error('Error creating room:', error);
                    alert('Failed to create room. Please try again.');
                });
        });

        // Join a room
        function joinRoom(roomId, roomName) {
            const user = auth.currentUser;
            if (!user) return;

            // Update active room in UI
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.room-item[data-room-id="${roomId}"]`).classList.add('active');
            document.querySelector('.chat-title').textContent = roomName;

            // Clear existing messages
            chatMessages.innerHTML = '<div class="typing-indicator" id="typingIndicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div><span>Someone is typing...</span></div>';

            // Load messages for this room
            database.ref(`messages/${roomId}`).limitToLast(100).on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayMessage(message, user.uid, roomId);
            });

            // Set current room in user data
            database.ref(`users/${user.uid}`).update({
                currentRoom: roomId
            });
        }

        // Modified setupChat function to handle multiple rooms
        function setupChat(user) {
            const messagesRef = database.ref('messages');
            const typingRef = database.ref('typing');
            const roomsRef = database.ref('rooms');
            let typingTimeout;
            let currentRoomId = null;

            // Load available rooms
            roomsRef.on('value', (snapshot) => {
                chatRoomsContainer.innerHTML = '';
                
                // Add "General Chat" as default room
                const defaultRoomItem = createRoomItem('general', 'General Chat', '', '');
                chatRoomsContainer.appendChild(defaultRoomItem);
                
                // Add other rooms
                snapshot.forEach((roomSnapshot) => {
                    const room = roomSnapshot.val();
                    const roomItem = createRoomItem(roomSnapshot.key, room.name, room.topic, room.type);
                    chatRoomsContainer.appendChild(roomItem);
                });
            });

            // Join the user's last room or general chat
            database.ref(`users/${user.uid}`).once('value').then((userSnapshot) => {
                const userData = userSnapshot.val();
                if (userData && userData.currentRoom) {
                    // Check if room exists
                    database.ref(`rooms/${userData.currentRoom}`).once('value').then((roomSnapshot) => {
                        if (roomSnapshot.exists()) {
                            const room = roomSnapshot.val();
                            joinRoom(userData.currentRoom, room.name);
                        } else {
                            joinRoom('general', 'General Chat');
                        }
                    });
                } else {
                    joinRoom('general', 'General Chat');
                }
            });

            // Create room item element
            function createRoomItem(roomId, name, topic, type) {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                roomItem.dataset.roomId = roomId;
                
                const typeIcon = type === 'private' ? '🔒' : '🌐';
                
                roomItem.innerHTML = `
                    <div class="room-avatar">${name.charAt(0)}</div>
                    <div class="room-info">
                        <div class="room-name">${name} ${typeIcon}</div>
                        <div class="room-last-message">${topic || 'No topic set'}</div>
                    </div>
                    <div class="room-meta">
                        <div class="room-time"></div>
                    </div>
                `;
                
                roomItem.addEventListener('click', () => {
                    joinRoom(roomId, name);
                });
                
                return roomItem;
            }

            // [Rest of the chat functionality remains the same]
            // ... (previous message sending, display, typing indicators, etc.)
        }

        // [Rest of the authentication and initialization code remains the same]
    </script>
</body>
</html>
